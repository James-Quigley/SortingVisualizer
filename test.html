<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TwoJS Test</title>
    <script src="two.min.js"></script>
    <script src="sorting.js"></script>
    <script src="state.js"></script>
    <style>
        * {
            padding: 0px;
            margin: 0px;
        }
        
        div {
            margin: 0px;
        }
    </style>
</head>

<body>
    <div id="displayArea" style="background:#404040;"></div>
    <label>Animation Speed: </label>
    <input type="number" id="delay" min=1 max="1000" value=1>
    <label>Array State: </label>
    <input type="number" id="currentState" min=0 value=0>
    <button id="bubble">Bubble</button>
    <button id="selection">Selection</button>
    <button id="cocktail">Cocktail Shaker</button>
    <button id="comb">Comb Sort</button>
    <button id="insertion">Insertion Sort</button>
    <button id="reset">Reset</button>
    <button id="stepBack">Back</button>
    <button id="stepNext">Next</button>
    <button id="start">Start</button>
    <button id="playBack">Play Backwards</button>
    <button id="stop">Stop</button>
    <p id="debug"></p>

    <script>
        var LEN = 25;
        // Retrieve the animation speed integer.
        var delay = parseInt(document.getElementById("delay").value);
        
        function randArray(length) {
            //grab the arr
            for (var arr = [], i = 0; i < length; ++i) arr[i] = i+1;

            // http://stackoverflow.com/questions/962802#962890
            var tmp, current, top = arr.length;
            if (top)
                while (--top) {
                    current = Math.floor(Math.random() * (top + 1));
                    tmp = arr[current];
                    arr[current] = arr[top];
                    arr[top] = tmp;
                }
            return arr;
        }

        var arr = randArray(LEN);
        var baseState = new State(arr, {});
        var states = [];
        states.push(baseState);
        var currentState = 0;

        //initialize two.js
        var xdef = 0;
        var height = 700;
        var maxWidth = window.innerWidth; //definitely look into moving into a setup() function that gets called when the window resizes
        var paddef = 1;
        var barWidth = ((maxWidth - (paddef * arr.length)) / arr.length)
        var primary = "#ffffff";
        var elem = document.getElementById("displayArea");
        var params = {
            width: maxWidth,
            height: height
        };
        var two = new Two(params).appendTo(elem);

        draw(baseState);

        var debstring = "";

        //Draws the state passed as a parameter
        function draw(state) {
            console.log("Redrawing");
            two.clear();
            //iterate through and draw it
            var max = Math.max(...state.data);
            var debug = document.getElementById("debug");
            for (index in state.data) {
                var x = xdef + (barWidth * index) + (paddef * index) + (1/2 * barWidth);
                //percent of the maxmimum value, scaled to total height of graph
                var barHeight = (state.data[index] / max) * height;
                var rect = two.makeRectangle(x, (height / 2) + (height / 2 - barHeight / 2) + 1, barWidth, barHeight);
                
                //If the color is null, make it default color. Else draw given color for index.
                if (state.colors[index]){
                    rect.fill = state.colors[index];
                } else{
                    rect.fill = primary;
                }
                rect.noStroke();
                two.update();
            }
        }
        var runner = null; 
        
        function playBack(){
            runner = setInterval(function(){console.log("stepping " + currentState);stepBack();},delay);
            console.log("starting");
        }
        function start(){
            runner = setInterval(function(){console.log("stepping " + currentState);stepNext();},delay);
            console.log("starting");
        }
        function stop(){
            clearInterval(runner);
        }
      
        //Step to next State

        function stepNext(){
            if (currentState != states.length -1){
                currentState++;
            }
            draw(states[currentState]);
            document.getElementById("currentState").value = currentState;
            if(currentState == states.length - 1){
                console.log("STOP NOW PLS");
                stop();
            }
        }
        
        //Go to previous State
        function stepBack(){
            if (currentState != 0) {
                currentState--;
            }
            draw(states[currentState]);
            document.getElementById("currentState").value = currentState;
            if(currentState == 0){
                console.log("STOP NOW PLS");
                stop();
            }
        }

        //*****************************************
        //  Button click handlers
        //  We have the delay values re-assigned
        //  inbetween function calls because we want
        //  to have the most recent updated user
        //  animation speed input.
        //*****************************************
        var obj = document.getElementById("bubble");
        obj.addEventListener("click", function () {
            delay = parseInt(document.getElementById("delay").value);
            states = bubbleSort(states[currentState].data);
        });

        //set state array to the value returned by selection sort
        obj = document.getElementById("selection");
        obj.addEventListener("click", function () {
            delay = parseInt(document.getElementById("delay").value);
            states = selectionSort(states[currentState].data);
        });

        obj = document.getElementById("cocktail");
        obj.addEventListener("click", function () {
            delay = parseInt(document.getElementById("delay").value);
            states = cocktailShakerSort(states[currentState].data)
        });

        obj = document.getElementById("comb");
        obj.addEventListener("click", function () {
            delay = parseInt(document.getElementById("delay").value);
            states = combSort(states[currentState].data)
        });
        
        obj = document.getElementById("insertion");
        obj.addEventListener("click", function () {
            delay = parseInt(document.getElementById("delay").value);
            states = insertionSort(states[currentState].data)
        });

        //reset state array. push new rand array.
        //Draw new base array. Set currentState
        obj = document.getElementById("reset");
        obj.addEventListener("click", function () {
            states = [];
            states.push(new State(randArray(LEN),{}));
            draw(states[0]);
            currentState = 0;
            document.getElementById("currentState").value = currentState;
            stop();
        });
        
        obj = document.getElementById("stepNext");
        obj.addEventListener("click", function () {
            stepNext();
        });
        
        obj = document.getElementById("stepBack");
        obj.addEventListener("click", function () {
            stepBack();
        });
        
        obj = document.getElementById("start");
        obj.addEventListener("click", function(){
            start();
        })
        
        obj = document.getElementById("stop");
        obj.addEventListener("click", function(){
            stop();
        })
        
        obj = document.getElementById("playBack");
        obj.addEventListener("click", function(){
            playBack();
        })
        
    </script>
</body>

</html>